import ast

import pytest

from app.services.cloud_service import CloudService
from app.utils.verify_youtube import parse_youtube_video_id, is_youtube_source_or_hostname, is_whitelist_youtube_item


@pytest.mark.parametrize(
    'url,expected_id',
    [
        ('https://youtu.be/Dlxu28sQfkE', 'Dlxu28sQfkE'),
        ('https://www.youtube.com/watch?v=Dlxu28sQfkE&feature=youtu.be', 'Dlxu28sQfkE'),
        ('https://www.youtube.com/watch/Dlxu28sQfkE', 'Dlxu28sQfkE'),
        ('https://www.youtube.com/embed/Dlxu28sQfkE', 'Dlxu28sQfkE'),
        ('https://www.youtube.com/shorts/Dlxu28sQfkE', 'Dlxu28sQfkE'),
        ('https://www.youtube.com/v/Dlxu28sQfkE', 'Dlxu28sQfkE'),
    ]
)
def test_get_youtube_video_id(url, expected_id):
    assert parse_youtube_video_id(url) == expected_id


@pytest.mark.parametrize(
    'source,page_url',
    [
        ('youtube', 'http://whatever.com'),
        ('x', 'https://youtu.be/Dlxu28sQfkE'),
        ('x', 'https://youtube.com/Dlxu28sQfkE'),
        ('x', 'https://www.youtube.com/Dlxu28sQfkE'),
        ('x', 'https://m.youtube.com/Dlxu28sQfkE'),
        ('x', 'https://music.youtube.com/Dlxu28sQfkE'),
        ('x', 'https://something.youtube.abc/Dlxu28sQfkE'),
        ('x', 'https://m.youtube.com/hashtag/—Ç–æ–±–∞—Ç—Å–ø–∏–¥–∏'),
    ]
)
def test_is_youtube_source_or_url(source, page_url):
    assert is_youtube_source_or_hostname(source, page_url) is True


@pytest.mark.parametrize(
    'expected, source,page_url',
    [
        (True, 'youtube', 'http://youtu.be/SA2iWivDJiE'),
        (True, 'youtube', 'http://www.youtube.com/watch?v=_oPAwA_Udwc&feature=feedu'),
        (True, 'youtube', 'http://www.youtube.com/embed/SA2iWivDJiE'),
        (True, 'youtube', 'http://www.youtube.com/shorts/SA2iWivDJiE'),
        (True, 'youtube', 'http://www.youtube.com/v/SA2iWivDJiE?version=3&amp;hl=en_US'),

        (False, 'youtube', 'https://abc.xyz.youtube/Dlxu28sQfkE'),
        (False, 'youtube', 'https://m.youtube.com/hashtag/—Ç–æ–±–∞—Ç—Å–ø–∏–¥–∏'),

        (None, 'x', 'https://whatever.com'),
    ]
)
def test_is_eligible_youtube_item(expected, source, page_url):
    assert is_whitelist_youtube_item(source, page_url) is expected


def test_tdd_verify_youtube():
    lens = ast.literal_eval("""
{'relatedTopics': [], 'matches': [{'domain': 'youtube', 'items': [{'title': 'GTA 5 Epic Ragdolls Spiderman Vs Hulk | Jumps/Fails #spidermanbike #hulk #gtav #gta - YouTube from YouTube', 'pageUrl': 'https://m.youtube.com/watch?v=xbEGUvgLuhE', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcS0hUz09a2Gh5Y762scGrx_cdhz5Xx3NncT27A2aCg0rCrWwh7C', 'source': 'YouTube'}, {'title': 'Indian Superman - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=w0b2Za1fLRk', 'imageUrl': 'https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSy8_ixRPmvSVwws8tYkAUoyAnehqKrg8a-MAlpACKWmBMoxIST', 'source': 'YouTube'}, {'title': 'All Blacks HAKA vs Superman, Batman and ...... ( 3d animation) - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=UETTjlJEy3U', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcS6BALLgjvVKQeclFjD44gKSivefNKvik9hYbdzLNYx2yF8JkAC', 'source': 'YouTube'}, {'title': 'Spiderman Finding Who is Real Superman of 100 Superman in GTA 5 üò± #shorts#trending #spiderman #gta - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=hPPizLJJ0TA', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYBfnESnvTBo2lJJNX-mmwkVc2X62uh9-9YYda1NSv-doOdHU9', 'source': 'YouTube'}, {'title': 'WE BECOME SUPERHEROES for 24 Hours ! **Something went wrong** - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=y16R4_NK-Zw', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcSPrkkiC1axd0OCEn2_KZnjLlFLqjGK-wV60tA42AGhyXfLTyIJ', 'source': 'YouTube'}, {'title': '#shorts #superman #gtav #gta #gta5mods #technogamerz - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=ATMJWbJu81Q', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcQb0flGfWRRlhdUBX2DtCU2hX951G-si0h6dB8KnkiDa2b7se_i', 'source': 'YouTube'}, {'title': '–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –æ—Ç ReAnimatori.lv - —Å–∞–º—ã–µ –≤–µ—Å—ë–ª—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏! - YouTube from YouTube', 'pageUrl': 'https://m.youtube.com/watch?v=eU9G-Ccutgs', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2DAqdxY-z9L4-lpFgULl7tlzhaea4Z8We6N9voMzN8DXsCp5I', 'source': 'YouTube'}, {'title': 'Mashup Hero All Heroes | All Characters - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=siK-g2JDnyI', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcQD3yhkkVSZ94WcCozM5xb6k3GsNZkW5fzDYnR6LOxmpdC7xE3V', 'source': 'YouTube'}, {'title': 'Superheroes of Dreamland - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=umi4JBzJ8AA', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcSzRH-GpKgXvZPU4hixx1fmPvALrOieThlCdJvwkBR8YBNHY4-d', 'source': 'YouTube'}, {'title': 'The spaiderman change in to man new funny shorts video#new#funny#video #shorts #technicalmangatrawat - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=I4A9fR02lEI', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcSA8L__wGSF6k5HeNXMCbeWz1wPxE7qu5ht8v-iujqTENuf1rpU', 'source': 'YouTube'}, {'title': 'Spider-Man vs Superman vs Hulk Monster Smashed Real Life #shorts #spiderman #ironman #viral - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=id2bUuDKj7g', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQT7heH0Pfx1n6wd-qtlMpun4Gc1owqUp8XuWKv3HwU3Wlq3Mqw', 'source': 'YouTube'}, {'title': "Superman's Father Was Come Form The Future in GTA 5 üò± #gta5 #viral #ytshorts #tranding - YouTube from YouTube", 'pageUrl': 'https://www.youtube.com/watch?v=GhoUBs-cS-M', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSpIDlvuRZCBceS1b4gzM4W6Vm5YeqGs8aIEFu3wkAB8bsIK4V7', 'source': 'YouTube'}, {'title': 'Superhero Dance Party - Spiderman, Superman, Iron Man & Mr Incredible | Funky Moves - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=d1S3luUl_a4', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcRGMnMkPN7yIY1smYYuY3F8OihA4Q7H4D8tx-iQNFwkDuiYAh-g', 'source': 'YouTube'}, {'title': "Superman's Father Was Come Form The Future in GTA 5 üò± #gta5 #shortsfeed #shorts - YouTube from YouTube", 'pageUrl': 'https://www.youtube.com/watch?v=fTFwi-bFMZI', 'imageUrl': 'https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSTjP2vRETpEVV_-zlP2pbXXOc1uszAeVlhXE6VwNlYLIO_C4LV', 'source': 'YouTube'}, {'title': 'GTA V : Dogs teach us love in its purest form # 8 ü•∫| #shorts #gta5 - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=44DHiD1qKTo', 'imageUrl': 'https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSpfkFfm4wiW9p7WktWk0I8UM2N1dZnvr_pYtbkGUhZvhnMKTFj', 'source': 'YouTube'}, {'title': 'Which Super Heros Can Win This Challenge Part 5 #gta5 #shorts - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=EEc1YDFEX9c', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQFkkdao1Pwn0q2MrDd_yL2yuwkcdEABxoCqyEUlopKqFvtzzEq', 'source': 'YouTube'}, {'title': 'Marvel couple - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=-NOuhC1SSOo', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcTaxyZubarP8qGQshV9bbTHcW_glkxu9a7Vhc3X-up9K-Ueu5Ct', 'source': 'YouTube'}, {'title': '#batman - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=A8zMR4Vktgc', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcRz30ZrEdZsM1Bn-cXSeWtOHFoFIsL_QLL-6guLps3T-rSDxynS', 'source': 'YouTube'}, {'title': 'Superhero Grand Entrance - Animated Cartoon Special Intro - YouTube from YouTube', 'pageUrl': 'https://m.youtube.com/watch?v=daAOn72FhXg', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrRI6hDaVs3kJu2Pt0MiEAk8NZFqo-BfuUhcRKGecRaUrxt-LX', 'source': 'YouTube'}, {'title': 'Spiderman vs Superman || Wrong head video || #ytshorts #india #trending - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=asBW0zn8h-c', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQbz83sj-ikzMsL5XrMp8LIWjn4HKOzTkmmnioAdtrHs1CnU_8z', 'source': 'YouTube'}, {'title': "Superman 's Father Was Come from the future in the GTA 5 üò±#gta5 #shortsfeed #vairalvideo #shorts - YouTube from YouTube", 'pageUrl': 'https://www.youtube.com/watch?v=SfichjkmIA4', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZMmoBFiYccy-Lz03vhZuIiP-l-g1VLopBE4HZtYWehPiLu_JH', 'source': 'YouTube'}, {'title': 'Superman & Supergirl Capes Flowing Green Screen (Christopher Reeve & Helen Slater) - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=kFZDsOGgD6o', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSZ89u0wHYRv_mXwqz_DhXODQ-RZjj2FM65KfL_-u51UjyS7ndp', 'source': 'YouTube'}, {'title': 'GTA 5 Epic Water Ragdolls | Spider-Man Jumps / Fails ep.1738 #shorts - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=Fv5lwqxaURc', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYGSklfpYWZ1q0IMLelMzCEIdmpZFeBIoE2hxEgNE2-Z8Qwyl0', 'source': 'YouTube'}, {'title': 'Spider-Man versus Hulk fight - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=isCLNIV9XzU', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcR9Vg3l1gHnFke6E_sTUcb4f-nwERG-f2K5Mc6FB8Bez5Jh44tN', 'source': 'YouTube'}, {'title': "Superman's Father Was Come Form The Future in GTA 5 üò± #gta5 #shorts #shortsfeed - YouTube from YouTube", 'pageUrl': 'https://www.youtube.com/watch?v=xrLxJRosZsI', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcSOpsiOUohtV4w3liFtqW1WElojzXiv2i9owyXZ4mNg4MRHF2bA', 'source': 'YouTube'}, {'title': '" How To Make Superman " | Fortnite - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=qwRJmE7kkiI', 'imageUrl': 'https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSXivFt39nilDP7LCidG6wyqp87vQTbRy8mHLbft7GsFWxeeAx5', 'source': 'YouTube'}, {'title': '‡¶π‡¶æ‡¶≤‡ßç‡¶ï vs ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ #gta #shortsviral #viral #shotrs # Superman vs Hulk# - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=EEDYtsVAc-k', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcA1bEe64g1eYVMl-JTwdNJ1HGKNSYuotHR-hgQ2gJfP5wjF-i', 'source': 'YouTube'}, {'title': 'Superman Father Was Come from the future in GTA V üò±ü§Ø#gta5 #shorts#shortvideo #shortsfeed#vairalvideo - YouTube from YouTube', 'pageUrl': 'https://www.youtube.com/watch?v=7EvNIiVfReQ', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcR9yKgRbq2IP_5yF5Hjaa0ktRXL0qFx6cBACn8cVaZEmlygk2UO', 'source': 'YouTube'}]}, {'domain': 'imdb', 'items': [{'title': 'Aleyna Dalveren feat. Dogus: Giden Gider (Music Video 2017) - IMDb from IMDb', 'pageUrl': 'https://www.imdb.com/title/tt9673504/', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcQwfDpOo40WY_uwJWxJn-PUBzvnVZamBBN4HGtvsrRkcbU6xYn-', 'source': 'IMDb'}]}, {'domain': 'turbosquid', 'items': [{'title': '3D Superman Models | TurboSquid from TurboSquid', 'pageUrl': 'https://www.turbosquid.com/Search/3D-Models/superman', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcTtxXC342BCXewuq_tszdrPDxr2Dk385U6Rfe9DvAa8jD9l-xN4', 'source': 'TurboSquid'}]}], 'omissions': [{'title': 'Superheroes discussing plans on Craiyon from Craiyon', 'pageUrl': 'https://www.craiyon.com/image/CiHGDH5ZQ6OwxbqwgZGI3A', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcRapjTkj_0-uGyT-ON9ChXf4H5DaEbSnJmLWG4hHmgCji1dU51A', 'source': 'Craiyon'}, {'title': 'Superman #1 Pose : r/Superboy from Reddit', 'pageUrl': 'https://www.reddit.com/r/Superboy/comments/oejjdg/superman_1_pose/', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVy-KbexT-1MeSiPcuSlmIg2PvjCvlkdegRx83qGyCOlWhVn_J', 'source': 'Reddit'}, {'title': 'here‚Äôs a custom homelander skin concept i made. hope y‚Äôall like it : r/FortNiteBR from Reddit', 'pageUrl': 'https://www.reddit.com/r/FortNiteBR/comments/15rtsne/heres_a_custom_homelander_skin_concept_i_made/', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcSHWHHcelzTUR28J69F8t5T6Cb9U8BsRLE4jYdGy3IF-ytGp1tX', 'source': 'Reddit'}, {'title': 'Strategic Planning ‚Äì Value Ecosystem Management ‚Äì Medium from Medium', 'pageUrl': 'https://medium.com/red-and-yellow-strategy-business-psychology/tagged/strategic-planning', 'imageUrl': 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTCYAiBVxTNFwLlAp385_u5ews2uKXxF63UrqmtHjF7AB3DtyQH', 'source': 'Medium'}, {'title': 'Meet Lizette, Director, Global Head of Vertical Solutions Marketing at Meta. Lizette felt empowered and unstoppable, thanks to her mentor‚Äôs trust in her abilities. from Threads', 'pageUrl': 'https://www.threads.net/@lifeatmeta/post/C4Qz8Jxx6f6', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQXWCApYGsJ5ExteRpVrQdt_sXEgvH796F4yHgo6RvIGum6rvM1', 'source': 'Threads'}, {'title': 'ArtStation - Superman Comic 1941 from ArtStation', 'pageUrl': 'https://www.artstation.com/artwork/kQ1lDK', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_Ia_KcJJSybkUBh1dWiXoa1_x1wae3HM7Wcf-tZDlbwMjbeZW', 'source': 'ArtStation'}, {'title': '1978 Zentai Suit Disguise Super Cosplay Costume High Quality Halloween Man Hero Bodysuit with Red $27.73* from AliExpress', 'pageUrl': 'https://www.aliexpress.com/item/1005006444205489.html', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSMmgAZZCRDSbwBDAKFRT7uAFsM4jeSEyBjcARQlt8HxWxWGBKo', 'source': ''}, {'title': "Superkids Custom Midjourney Prompts: Inspiring Little Heroes' Smiles $3.98* from Socialdraft", 'pageUrl': 'https://socialdraft.com/products/superkids-custom-midjourney-prompts-inspiring-little-heroes-smiles-midjourney-prompt', 'imageUrl': 'https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcQ5oBS3IxmBz1F66RBWS4KkP1ZK4fiSXuQ2L0O1h57yGL4LDbdg', 'source': ''}, {'title': "I couldn't get the superman skin so I made this instead. Thoughts? : r/FortNiteBR from Reddit", 'pageUrl': 'https://www.reddit.com/r/FortNiteBR/comments/12d0nii/i_couldnt_get_the_superman_skin_so_i_made_this/', 'imageUrl': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQ3k4-X3F0ATEH2UUpV6YCauAfkEXOxSizQPAmlWInoVlu388yc', 'source': 'Reddit'}, {'title': 'BigDog - Playground from Playground AI', 'pageUrl': 'https://playground.com/profile/clgo6q6ff0uc2s6019nd376rc', 'imageUrl': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRL2odunMu7DjtykoPslbLtFHU2sFIRnb9uynCQGQu-5zY8_p8u', 'source': 'Playground AI'}]}
""")
    custom_search = {
        'matches': [],
        'omissions': []
    }

    CloudService.conclude_social_media_official_accounts(lens, custom_search)

    assert custom_search is not None
